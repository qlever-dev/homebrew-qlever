name: Test Homebrew Formula

on:
  workflow_dispatch:  # Allow manual triggers

jobs:
  test-homebrew-install:
    runs-on: macos-14

    steps:
      - name: Check runner architecture
        run: |
          echo "Architecture: $(uname -m)"
          echo "macOS version: $(sw_vers -productVersion)"
          echo "Runner: ${{ matrix.os }}"

      - name: Update Homebrew
        run: brew update

      - uses: actions/checkout@v4

      - name: Install formula from local tap
        run: |
          brew tap-new $USER/local-tap
          cp Formula/*.rb $(brew --repository $USER/local-tap)/Formula/
          cp -r patches $(brew --repository $USER/local-tap)/ || true
          brew install --build-from-source $USER/local-tap/qlever
          brew test $USER/local-tap/qlever
          brew test $USER/local-tap/qlever-control

      - name: Verify binaries are installed
        run: |
          which qlever-server
          which qlever-index
          which qlever

      - name: Test qlever-index
        run: |
          qlever-index --version
          qlever-index --help

      - name: Test qlever-server
        run: |
          qlever-server --version
          qlever-server --help
      
      - name: Test qlever-control
        run: |
          qlever --version
          qlever --help

      - name: Verify dynamic libraries resolve
        run: |
          echo "=== qlever-server dependencies ==="
          otool -L $(which qlever-server)
          echo ""
          echo "=== qlever-index dependencies ==="
          otool -L $(which qlever-index)

      - name: Test qlever script for olympics dataset (native is default)
        timeout-minutes: 3
        run: |
          mkdir -p qlever-indices/olympics && cd $_
          qlever setup-config olympics

          # Verify the generated Qleverfile has SYSTEM = native
          echo "Generated Qleverfile SYSTEM setting:"
          grep -i "SYSTEM" Qleverfile

          # Run without --system flag to verify native is the default
          qlever get-data
          qlever index
          qlever start
          qlever status
          qlever query
          qlever stop
          ls -lh
